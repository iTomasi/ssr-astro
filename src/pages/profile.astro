---
import Layout from "layouts/Layout.astro";
import isUserAuthenticated from "helpers/isUserAuthenticated";
import Profile from "components/profile";
import getUser from "databases/functions/getUser";
import getUrlQuery from "helpers/getUrlQuery"
import { IUserProp } from "types/User";

const { user: userQuery } = getUrlQuery(Astro.request.url);
const username = userQuery || ""
let user = null
let session: IUserProp = false;

if (username) {
  session = await isUserAuthenticated(Astro)

  if (session && session.username.toLowerCase() === username?.toLowerCase()) {
    user = session
  }

  else {
    if (username) {
      const { data } = await getUser(username.toLowerCase());

      if (data) user = data
    }
  }
}


---

<Layout user={session}>
  {
    !username && (
      <h1>You need to add ?user=username to your url!</h1>
    )
  }

  {
    username && (user
      ? <Profile user={user}/>
      : <h1>No user found</h1>
    )
  }
</Layout>